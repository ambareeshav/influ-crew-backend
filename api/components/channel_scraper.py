import gc  # Import garbage collection module
from apify_client import ApifyClient
from datetime import datetime
import os
from dotenv import load_dotenv
import logging  
from typing import Dict, Any  

load_dotenv()

KEY = "apify_api_QSBzzsSVCE1XLwdw9mXemldnfIhXdq0qXCSR"

client = ApifyClient(KEY)
# Import custom modules
import api.components.summarizer as summarizer

# Configure logging
logging.basicConfig(level=logging.ERROR)  
logger = logging.getLogger(__name__)

def video_det_store(run: Dict[str, Any], channel_info: Dict[str, Any]) -> None:  
    # Iterate through videos in the dataset  
    for video in client.dataset(run["defaultDatasetId"]).iterate_items():
        try:
            channelId = video.get('channelUrl').split("/")[-1]
            
            # If channel not in channel_info, add it
            if channelId not in channel_info:
                # Initialize channel information
                channel_info[channelId] = {
                    'channel_name': video.get('channelName'),
                    'channel_description_links': video.get('channelDescriptionLinks'),
                    'subscriber_count': video.get('numberOfSubscribers'),
                    'video_dates': [],
                    'videos': []
                }
            
            # Add video date to the channel's video_dates list
            try:
                channel_info[channelId]['video_dates'].append(str((datetime.fromisoformat(video.get('date'))).date()))
            except Exception as e:
                logging.error(f"DATE ERROR - {e}")
            
            # Get video transcript
            try:
                summarized_transcript = summarizer.summarize(video.get('id'))
            except Exception as e:
                summarized_transcript = None
                logger.error(f"SUMMARIZED TRANSCRIPT ERROR - {e}")  # Replaced print with logger

            # Add video details to the channel's videos list
            try:
                channel_info[channelId]['videos'].append({
                    'date': str((datetime.fromisoformat(video.get('date'))).date()),
                    'title': video.get('title'),
                    'viewCount': video.get('viewCount'),
                    'likeCount': video.get('likes'),
                    'commentsCount': video.get('commentsCount'),
                    'transcript_report': summarized_transcript,
                    'duration': video.get('duration'),
                    'description': video.get('text'),
                    'description_links': video.get('descriptionLinks')
                })
            except Exception as e:
                logger.error(f"ERROR - {e}") 

            # Manually trigger garbage collection to free up memory
            gc.collect()  # Collect unreferenced objects in the current scope

        except Exception as e:
            channel_info = None
            logger.error(f"store_vid_dets - {e}") 
            gc.collect()  # Trigger GC in case of exceptions too

def get_video_det(channel_info, link):
    # Define input parameters for YouTube scraper
    input = {
        "downloadSubtitles": False,
        "hasCC": False,
        "hasLocation": False,
        "hasSubtitles": False,
        "is360": False,
        "is3D": False,
        "is4K": False,
        "isBought": False,
        "isHD": False,
        "isHDR": False,
        "isLive": False,
        "isVR180": False,
        "maxResultStreams": 0,
        "maxResults": 5,
        "maxResultsShorts": 0,
        "preferAutoGeneratedSubtitles": False,
        "saveSubsToKVS": False,
        "startUrls": [
        {
            "url": link
        }
        ],
        "subtitlesLanguage": "any",
        "subtitlesFormat": "srt"
    }

    # Run YouTube scraper
    run = client.actor("streamers/youtube-scraper").call(run_input=input)

    # Store details of current video in iteration
    print("STATE - Storing Video Details")
    video_det_store(run, channel_info)

    # Trigger garbage collection after the entire run
    gc.collect()

    return channel_info

def cscraper(link):
    # Initialize channel_info dictionary
    channel_info = {}

    # Get video details for the given link
    channel_info = get_video_det(channel_info, link)

    # Final garbage collection after the entire operation
    gc.collect()

    return channel_info
